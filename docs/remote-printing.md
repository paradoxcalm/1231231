# Удалённая печать чеков

## Архитектура

1. Пользователь в веб-интерфейсе загружает PDF или вводит текст чека.
2. `printer.php` отправляет запрос на удалённый сервер печати, указывая секретный токен.
3. `printer_server.py`, запущенный на рабочем месте с подключённым термопринтером, принимает запрос и отправляет задание в очередь печати Windows.

## Настройка сайта

1. Отредактируйте файл [`print_config.php`](../print_config.php) и укажите:
   - `PRINT_SERVICE_URL` — адрес компьютера с термопринтером. Пример: `http://192.168.1.50:5000`.
   - `PRINT_SERVICE_TOKEN` — произвольный длинный секрет. Должен совпадать со значением переменной окружения `PRINT_SERVER_TOKEN` на сервере печати.
   - `PRINT_SERVICE_TIMEOUT` — время ожидания ответа, по умолчанию 15 секунд.
2. В разделе «Принтер» можно загружать PDF или отправлять текст.
   - Для текста доступен выбор кодировки и флажок «Отрезать чек» (ESC/POS команда полного отреза).

## Настройка сервера печати

1. Установите зависимости Python (рекомендуется виртуальное окружение):
   ```bash
   pip install flask pywin32 pypdf2
   ```
2. Скачайте файл [`printer_server.py`](../printer_server.py) на Windows‑ПК, где подключён термопринтер.
3. Установите переменные окружения (можно через «Изменение системных переменных» или файл `.bat`):
   - `PRINT_SERVER_TOKEN` — тот же токен, что и на сайте.
   - По желанию:
     - `PRINT_ADOBE_READER` — путь к `Acrobat.exe`, если нужен альтернативный путь для печати PDF.
     - `PRINT_FONT_PATH` — путь к TTF‑шрифту, если понадобится печать PDF через Acrobat.
     - `PRINT_TEXT_ENCODING` — кодировка по умолчанию для текстовых чеков (например, `cp1251`).
4. Запустите `printer_server.py`. В появившемся окне выберите принтер и ориентацию для PDF.
5. Оставьте окно запущенным. Flask‑сервер будет слушать порт 5000 и принимать запросы `/print/file` и `/print/text`.

## Проверка работы

- Для теста можно выполнить команду (замените IP и токен):
  ```bash
  curl -X POST "http://192.168.1.50:5000/print/text" \
       -H "X-Auth-Token: <секрет>" \
       -F "text=Тестовая печать" \
       -F "encoding=utf-8" \
       -F "cut=1"
  ```
- В ответ сервер вернёт JSON `{ "success": true, "message": "Печать начата" }`.
- В случае ошибок сообщения будут записаны в `log.txt` рядом со скриптом.

## Советы по безопасности

- Откройте порт 5000 только для доверенных IP (например, настройте правило в межсетевом экране).
- Регулярно меняйте токен и не храните его в публичных репозиториях.
- Логи содержат только техническую информацию; следите, чтобы не печатались персональные данные без шифрования каналов.
